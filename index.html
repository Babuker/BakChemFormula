<!DOCTYPE html>
<html lang="ar" dir="rtl" id="mainTag">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BakChemformula | Expert System v5.6</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <style>
        :root { --primary: #0e4b62; --secondary: #3498db; --accent: #27ae60; --hybrid: #f39c12; --danger: #e74c3c; --bg: #f4f7f9; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .grid-layout { max-width: 1200px; margin: auto; display: flex; flex-direction: column; gap: 20px; }
        .section-box { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 25px; border: 1px solid #e2e8f0; }
        
        .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
        .lang-toggle { background: var(--primary); color: white; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; align-items: end; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary); }
        select, input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; }
        
        .btn-run { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; transition: 0.3s; }
        .btn-run:hover { opacity: 0.9; transform: translateY(-1px); }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ÙƒÙØ§Ø¡Ø© ÙÙˆÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .efficiency-container { margin-bottom: 15px; background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px solid #edf2f7; }
        .q-label-flex { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; color: var(--primary); }
        .bar-bg { height: 12px; background: #e2e8f0; border-radius: 10px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--secondary), var(--accent)); transition: 1s cubic-bezier(0.17, 0.67, 0.83, 0.67); }

        .analysis-flex { display: flex; gap: 25px; flex-wrap: wrap; }
        .table-side { flex: 2; min-width: 400px; }
        .chart-side { flex: 1; min-width: 280px; background: #f8fafc; padding: 15px; border-radius: 12px; text-align: center; }

        .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { padding: 20px; border-radius: 10px; background: #fff; border: 1px solid #eee; border-right: 6px solid var(--secondary); }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f5f9; color: var(--primary); padding: 12px; border: 1px solid #e2e8f0; font-size: 14px; }
        td { padding: 10px; border: 1px solid #e2e8f0; text-align: center; font-size: 14px; }

        #resultsArea { display: none; }
    </style>
</head>
<body>

<div class="grid-layout">
    <div class="section-box">
        <div class="header-controls">
            <h2 id="t_h1" style="margin:0; color:var(--primary)">1. Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø®Ø¨ÙŠØ±</h2>
            <button class="lang-toggle" onclick="toggleLang()" id="langBtn">English Interface</button>
        </div>
        <div class="input-grid">
            <div><label id="t_api">Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ÙØ¹Ø§Ù„Ø©:</label><select id="apiSelect"></select></div>
            <div><label id="t_batch">Ø­Ø¬Ù… Ø§Ù„ØªØ´ØºÙŠÙ„Ø©:</label><input type="number" id="batchSize" value="10000"></div>
            <div><label id="t_strat">Ø¥Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„ØªØµÙ†ÙŠØ¹:</label>
                <select id="strategy">
                    <option value="quality">Ø¬ÙˆØ¯Ø© ÙØ§Ø¦Ù‚Ø© (Quality)</option>
                    <option value="hybrid" selected>Ø§Ù„ØªÙˆØ§Ø²Ù† (Balanced)</option>
                    <option value="cost">Ø§Ù‚ØªØµØ§Ø¯ÙŠØ© (Economy)</option>
                </select>
            </div>
            <button class="btn-run" onclick="runAnalysis()" id="t_btn_run">ØªØ­Ù„ÙŠÙ„ ÙˆÙ…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ±ÙƒÙŠØ¨Ø©</button>
        </div>
    </div>

    <div id="resultsArea">
        <div class="section-box">
            <h2 id="t_h2" style="color:var(--primary); margin-top:0; margin-bottom:15px">2. ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙŠØºØ© ÙˆÙ…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ÙƒÙØ§Ø¡Ø©</h2>
            
            <div class="analysis-flex">
                <div class="table-side">
                    <div class="efficiency-container">
                        <div class="q-label-flex">
                            <span id="t_q_label">Ù…Ø¤Ø´Ø± ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©:</span>
                            <span id="percText">0%</span>
                        </div>
                        <div class="bar-bg"><div id="perfFill" class="bar-fill"></div></div>
                    </div>

                    <table id="formulaTable">
                        <thead><tr id="th_row"><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„ÙˆØ¸ÙŠÙØ©</th><th>(mg)</th><th>%</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th></tr></thead>
                        <tbody id="formulaBody"></tbody>
                    </table>
                </div>
                <div class="chart-side">
                    <canvas id="myChart" style="max-height: 180px;"></canvas>
                    <div id="chartLegend" style="margin-top:10px; font-size:0.8em; display:flex; flex-wrap:wrap; gap:8px; justify-content:center"></div>
                    <hr style="margin:15px 0; opacity:0.2">
                    <h4 id="t_compare_title" style="font-size:0.9em; color:var(--primary)">Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ ($)</h4>
                    <div style="height: 120px;"><canvas id="compareChart"></canvas></div>
                </div>
            </div>
        </div>

        <div class="details-grid">
            <div class="card"><h4 id="t_h_prod">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙ†ÙŠØ© Ù„Ù„ØªØ´ØºÙŠÙ„Ø©:</h4><div id="prodContent"></div></div>
            <div class="card" style="border-right-color: var(--danger);"><h4 id="t_h_risk" style="color:var(--danger)">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ø·Ø± ÙˆØ§Ù„ØªÙˆØµÙŠØ§Øª:</h4><div id="riskContent"></div></div>
        </div>

        <div class="section-box" style="text-align:center; border:none; background:none;">
            <button class="btn-run" style="background:var(--accent); max-width:320px" onclick="exportPDF()" id="t_btn_pdf">ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„ PDF</button>
        </div>
    </div>
</div>

<canvas id="barcode" style="display:none"></canvas>

<script>
let currentLang = 'ar';
let donutChart = null, barChart = null;

const db = {
    "Paracetamol": { dose: 500, p_kg: 14.8, process: "Direct Compression", risk: "Monitor flowability. Store < 25Â°C.", color: "#0e4b62" },
    "Ibuprofen": { dose: 400, p_kg: 28.5, process: "Wet Granulation", risk: "Low melting point. Avoid heat.", color: "#2980b9" },
    "Amoxicillin": { dose: 500, p_kg: 45.0, process: "Dry Granulation", risk: "Hygroscopic. Use Alu-Alu pack.", color: "#c0392b" },
    "Metformin": { dose: 850, p_kg: 12.0, process: "Wet Granulation", risk: "High dose. Use binder 5%.", color: "#8e44ad" },
    "Atorvastatin": { dose: 20, p_kg: 440.0, process: "Direct Compression", risk: "Oxygen sensitive. Nitrogen flush.", color: "#f39c12" },
    "Aspirin": { dose: 100, p_kg: 9.5, process: "Direct Compression", risk: "Hydrolysis risk. Keep RH < 30%.", color: "#16a085" },
    "Omeprazole": { dose: 20, p_kg: 195.0, process: "Encapsulation", risk: "Acid labile. Enteric coating.", color: "#2c3e50" }
};

const fillers = [
    { name: "Avicel PH-102", role: "Filler", p_kg: 5.5, color: "#3498db" },
    { name: "Ac-Di-Sol", role: "Disintegrant", p_kg: 22.0, color: "#2ecc71" },
    { name: "Mg Stearate", role: "Lubricant", p_kg: 15.0, color: "#f1c40f" }
];

const langs = {
    ar: { t_h1: "1. Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø®Ø¨ÙŠØ±", t_h2: "2. ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙŠØºØ© ÙˆÙ…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ÙƒÙØ§Ø¡Ø©", t_api: "Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ÙØ¹Ø§Ù„Ø©:", t_batch: "Ø­Ø¬Ù… Ø§Ù„ØªØ´ØºÙŠÙ„Ø©:", t_strat: "Ø¥Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„ØªØµÙ†ÙŠØ¹:", t_btn_run: "ØªØ­Ù„ÙŠÙ„ ÙˆÙ…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ±ÙƒÙŠØ¨Ø©", t_h_prod: "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙ†ÙŠØ© Ù„Ù„ØªØ´ØºÙŠÙ„Ø©:", t_h_risk: "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ø·Ø± ÙˆØ§Ù„ØªÙˆØµÙŠØ§Øª:", t_btn_pdf: "ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„ PDF", t_q_label: "Ù…Ø¤Ø´Ø± ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©:", t_compare_title: "Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ ($)", th: ["Ø§Ù„Ù…Ø§Ø¯Ø©", "Ø§Ù„ÙˆØ¸ÙŠÙØ©", "(mg)", "%", "Ø§Ù„ØªÙƒÙ„ÙØ©"], btn: "English Interface" },
    en: { t_h1: "1. Expert System Inputs", t_h2: "2. Formula Analysis & Efficiency", t_api: "Active API:", t_batch: "Batch Size:", t_strat: "Optimization:", t_btn_run: "Run Simulation", t_h_prod: "Production Details:", t_h_risk: "Risks & Recommendations:", t_btn_pdf: "Export Technical PDF", t_q_label: "Efficiency Index:", t_compare_title: "Cost Comparison ($)", th: ["Material", "Role", "(mg)", "%", "Cost"], btn: "Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©" }
};

function toggleLang() {
    currentLang = currentLang === 'ar' ? 'en' : 'ar';
    document.getElementById('mainTag').dir = currentLang === 'ar' ? 'rtl' : 'ltr';
    document.getElementById('langBtn').innerText = langs[currentLang].btn;
    const t = langs[currentLang];
    for(let id in t) if(document.getElementById(id)) document.getElementById(id).innerText = t[id];
    const heads = document.querySelectorAll('#th_row th');
    t.th.forEach((txt, i) => heads[i].innerText = txt);
    if(document.getElementById('resultsArea').style.display === 'block') runAnalysis();
}

window.onload = () => {
    const s = document.getElementById('apiSelect');
    Object.keys(db).forEach(n => s.options[s.options.length] = new Option(n, n));
};

function runAnalysis() {
    const apiName = document.getElementById('apiSelect').value;
    const api = db[apiName];
    const batch = parseInt(document.getElementById('batchSize').value);
    const strat = document.getElementById('strategy').value;
    document.getElementById('resultsArea').style.display = 'block';

    let score = strat === 'quality' ? 98 : (strat === 'hybrid' ? 88 : 72);
    document.getElementById('perfFill').style.width = score + '%';
    document.getElementById('percText').innerText = score + '%';

    let factor = strat === 'quality' ? 0.3 : (strat === 'hybrid' ? 0.2 : 0.1);
    const formula = [{ name: apiName, role: "API", qty: api.dose, color: api.color, p_kg: api.p_kg }, ...fillers.map(ex => ({ ...ex, qty: Math.round(api.dose * factor) }))];

    let currentTotal = 0;
    const totalW = api.dose * (1 + factor * 3);
    document.getElementById('formulaBody').innerHTML = formula.map(f => {
        let cost = (f.qty * (f.p_kg || 5) * batch / 1000000).toFixed(2);
        currentTotal += parseFloat(cost);
        return `<tr><td style="color:${f.color}; font-weight:bold">${f.name}</td><td>${f.role}</td><td>${f.qty}</td><td>${((f.qty/totalW)*100).toFixed(1)}%</td><td>$${cost}</td></tr>`;
    }).join('');

    renderCharts(api, batch, formula);
    
    document.getElementById('prodContent').innerHTML = `â€¢ Ø§Ù„ÙˆØ²Ù† Ø§Ù„ÙƒÙ„ÙŠ: ${Math.round(totalW)} mg<br>â€¢ ØªÙƒÙ„ÙØ© Ø§Ù„ØªØ´ØºÙŠÙ„Ø©: <b>$${currentTotal.toLocaleString()}</b><br>â€¢ Ø§Ù„ØªØºÙ„ÙŠÙ: Alu-PVC Blister`;
    document.getElementById('riskContent').innerHTML = `âš ï¸ <b>Ø§Ù„Ù…Ø®Ø§Ø·Ø±:</b> ${api.risk}<br>ğŸ’¡ <b>Ø§Ù„ØªÙˆØµÙŠØ©:</b> Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© ${strat} Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„ØªØ´ØºÙŠÙ„Ø©.`;
}

function renderCharts(api, batch, formula) {
    if(donutChart) donutChart.destroy();
    donutChart = new Chart(document.getElementById('myChart'), {
        type: 'doughnut',
        data: { labels: formula.map(f=>f.name), datasets: [{ data: formula.map(f=>f.qty), backgroundColor: formula.map(f=>f.color) }] },
        options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
    document.getElementById('chartLegend').innerHTML = formula.map(f=>`<div><span style="color:${f.color}">â– </span> ${f.name}</div>`).join('');

    const calc = (f) => (api.dose * api.p_kg * batch / 1000000) + (3 * (api.dose * f * 12 * batch / 1000000));
    if(barChart) barChart.destroy();
    barChart = new Chart(document.getElementById('compareChart'), {
        type: 'bar',
        data: {
            labels: currentLang === 'ar' ? ['Ø¬ÙˆØ¯Ø©', 'ØªÙˆØ§Ø²Ù†', 'Ø§Ù‚ØªØµØ§Ø¯'] : ['Quality', 'Hybrid', 'Cost'],
            datasets: [{ data: [calc(0.3), calc(0.2), calc(0.1)], backgroundColor: ['#0e4b62', '#f39c12', '#27ae60'] }]
        },
        options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
}

async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();
    
    doc.setTextColor(240); doc.setFontSize(45);
    for(let i=0; i<210; i+=60) for(let j=0; j<300; j+=70) doc.text("BAKCHEM", i, j, {angle:45});

    doc.setFontSize(18); doc.setTextColor(14, 75, 98);
    doc.text("BakChemformula Tech Report v5.6", 105, 20, {align:"center"});
    
    doc.setFontSize(11); doc.setTextColor(0);
    doc.text(`${langs[currentLang].t_q_label} ${document.getElementById('percText').innerText}`, 15, 30);

    doc.autoTable({ html: '#formulaTable', startY: 35, theme: 'grid', headStyles: {fillColor:[14, 75, 98]} });
    
    let finalY = doc.lastAutoTable.finalY;
    doc.addImage(document.getElementById('myChart').toDataURL(), 'PNG', 15, finalY + 10, 50, 50);
    doc.addImage(document.getElementById('compareChart').toDataURL(), 'PNG', 80, finalY + 10, 110, 50);

    doc.setFontSize(12); doc.setTextColor(14, 75, 98);
    doc.text(langs[currentLang].t_h_prod, 15, finalY + 75);
    doc.setFontSize(10); doc.setTextColor(0);
    doc.text(document.getElementById('prodContent').innerText.replace(/<br>/g, '\n'), 15, finalY + 85);

    doc.setFontSize(12); doc.setTextColor(231, 76, 60);
    doc.text(langs[currentLang].t_h_risk, 15, finalY + 105);
    doc.setFontSize(10); doc.setTextColor(0);
    doc.text(document.getElementById('riskContent').innerText.replace(/<br>/g, '\n').replace(/<b>/g,'').replace(/<\/b>/g,''), 15, finalY + 115);

    JsBarcode("#barcode", "BK-2026-X56");
    doc.addImage(document.getElementById("barcode").toDataURL(), 'PNG', 160, 280, 40, 10);
    doc.save("BakChem_Final_Technical_Report.pdf");
}
</script>
</body>
</html>
