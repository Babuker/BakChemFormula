<!DOCTYPE html>
<html lang="ar" dir="rtl" id="mainTag">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BakChemformula | Expert System Suite</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <style>
        :root { --primary: #0e4b62; --secondary: #3498db; --accent: #27ae60; --bg: #f0f2f5; --white: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 15px; transition: 0.3s; }
        .grid-layout { display: flex; flex-direction: column; gap: 20px; max-width: 1200px; margin: auto; }
        .section-box { background: var(--white); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 25px; border: 1px solid #e1e4e8; position: relative; }
        
        /* زر تبديل اللغة */
        .lang-toggle { position: absolute; top: 15px; left: 15px; background: var(--secondary); color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; z-index: 10; }

        /* المساحة 1: المدخلات */
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; align-items: end; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--primary); }
        select, input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn-run { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; }
        .btn-run:hover { opacity: 0.9; }

        /* المساحة 2: الأداء والتركيبة */
        .q-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .performance-bar { height: 28px; background: #eee; border-radius: 15px; position: relative; overflow: hidden; margin-bottom: 20px; }
        .fill { height: 100%; background: linear-gradient(90deg, var(--secondary), var(--accent)); width: 0%; transition: 1.5s cubic-bezier(0.1, 0.7, 1.0, 0.1); }
        .formula-container { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        .legend-box { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px; font-size: 0.85em; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 12px; height: 12px; border-radius: 2px; }

        /* المساحة 3: التشغيلة والتوصيات */
        .details-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: #f8f9fa; padding: 18px; border-right: 6px solid var(--secondary); border-radius: 8px; }
        
        /* المساحة 4: التصدير والقانوني */
        .footer-section { text-align: center; }
        .legal-text { font-size: 0.85em; color: #777; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }

        table { width: 100%; border-collapse: collapse; font-size: 0.95em; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: center; }
        th { background: #f4f6f8; color: var(--primary); }
        
        #resultsArea { display: none; }
        @media (max-width: 768px) { .formula-container, .details-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="grid-layout">
    <div class="section-box">
        <button class="lang-toggle" onclick="toggleLang()" id="langBtn">English</button>
        <h2 id="h1" style="color:var(--primary); margin-top:0">1. خيارات المستخدم والمدخلات</h2>
        <div class="input-grid">
            <div>
                <label id="l_api">المادة الفعالة (API):</label>
                <select id="apiSelect">
                    <option value="Paracetamol">Paracetamol (Analgesic)</option>
                    <option value="Diclofenac">Diclofenac (Acid Sensitive)</option>
                    <option value="Metronidazole">Metronidazole (Bitter)</option>
                </select>
            </div>
            <div>
                <label id="l_batch">حجم التشغيلة (Batch Units):</label>
                <input type="number" id="batchSize" value="1000">
            </div>
            <div>
                <label id="l_strat">استراتيجية التحسين:</label>
                <select id="strategy">
                    <option value="quality">جودة عالية (Q1/Q2 Compliance)</option>
                    <option value="cost">تحسين التكلفة (Cost Optimized)</option>
                </select>
            </div>
            <button class="btn-run" onclick="runBakChem()" id="btn_run">تحليل النظام</button>
        </div>
    </div>

    <div class="section-box" id="resultsArea">
        <h2 id="h2" style="color:var(--primary); margin-top:0">2. تقييم الأداء والتركيبة المقترحة</h2>
        <div class="q-header">
            <span id="l_qi" style="font-weight:bold">نسبة تحقق الجودة (Quality Index):</span>
            <b id="percText" style="color:var(--accent); font-size:1.4em">0%</b>
        </div>
        <div class="performance-bar"><div id="perfFill" class="fill"></div></div>
        
        <div class="formula-container">
            <div>
                <table id="formulaTable">
                    <thead><tr id="th_row"><th>المادة</th><th>الوظيفة</th><th>(mg)</th><th>النسبة</th><th>التكلفة</th></tr></thead>
                    <tbody id="formulaBody"></tbody>
                </table>
            </div>
            <div style="text-align:center">
                <canvas id="myChart"></canvas>
                <div id="chartLegend" class="legend-box"></div>
            </div>
        </div>
    </div>

    <div class="section-box">
        <h2 id="h3" style="color:var(--primary); margin-top:0">3. تفاصيل التشغيلة والتوصيات الفنية</h2>
        <div class="details-container">
            <div class="card" id="card_prod">
                <h4 id="h_prod" style="margin-top:0">بيانات الإنتاج والمالية:</h4>
                <div id="prodContent"></div>
            </div>
            <div class="card" style="border-color:var(--accent)" id="card_rec">
                <h4 id="h_rec" style="margin-top:0">توصيات البيئة والتخزين:</h4>
                <div id="recContent"></div>
            </div>
        </div>
    </div>

    <div class="section-box footer-section">
        <button class="btn-run" style="background:var(--accent); max-width:350px" onclick="exportPDF()" id="btn_pdf">تصدير التقرير الفني الشامل (PDF)</button>
        <div class="legal-text">
            <p><b>BakChemformula Expert System</b> | <span id="reg_id">رقم التسجيل الملكي الفكري: BK-USP-2026-REG</span></p>
            <p id="legal_info">هذا النظام مسجل رسمياً كأداة ذكاء اصطناعي صيدلانية لدعم قرارات التصنيع. جميع الحقوق محفوظة لشركة BakChem.</p>
        </div>
    </div>
</div>

<canvas id="barcode" style="display:none"></canvas>

<script>
let currentLang = 'ar';
const i18n = {
    ar: {
        h1: "1. خيارات المستخدم والمدخلات", h2: "2. تقييم الأداء والتركيبة المقترحة", h3: "3. تفاصيل التشغيلة والتوصيات الفنية",
        l_api: "المادة الفعالة (API):", l_batch: "حجم التشغيلة:", l_strat: "استراتيجية التحسين:", btn_run: "تحليل النظام",
        th: ["المادة", "الوظيفة", "وزن(mg)", "النسبة%", "تكلفة التشغيلة"], h_prod: "بيانات الإنتاج والمالية:",
        h_rec: "توصيات البيئة والتغليف:", btn_pdf: "تصدير التقرير الفني الشامل (PDF)", l_qi: "نسبة تحقق الجودة (Quality Index):",
        legal_info: "هذا النظام مسجل رسمياً كأداة ذكاء اصطناعي صيدلانية لدعم قرارات التصنيع. جميع الحقوق محفوظة لشركة BakChem."
    },
    en: {
        h1: "1. User Selection & Inputs", h2: "2. Performance Evaluation & Formulation", h3: "3. Batch Details & Technical Recommendations",
        l_api: "Active API Selection:", l_batch: "Batch Size (Units):", l_strat: "Optimization Strategy:", btn_run: "Analyze & Run System",
        th: ["Material", "Role", "Weight(mg)", "Percentage%", "Batch Cost"], h_prod: "Production & Financial Data:",
        h_rec: "Storage & Packaging Recs:", btn_pdf: "Export Professional PDF Report", l_qi: "Quality Index Score:",
        legal_info: "This system is officially registered as a pharmaceutical AI tool for manufacturing decisions. All rights reserved to BakChem."
    }
};

const apiDb = {
    "Paracetamol": { dose: 500, cost: 14.5, process: "Direct Compression", color: "#0e4b62" },
    "Diclofenac": { dose: 50, cost: 82.0, process: "Wet Granulation", color: "#e67e22" },
    "Metronidazole": { dose: 500, cost: 38.0, process: "Direct Compression", color: "#8e44ad" }
};

let chartObj = null;

function toggleLang() {
    currentLang = currentLang === 'ar' ? 'en' : 'ar';
    document.getElementById('mainTag').dir = currentLang === 'ar' ? 'rtl' : 'ltr';
    document.getElementById('langBtn').innerText = currentLang === 'ar' ? 'English' : 'العربية';
    const t = i18n[currentLang];
    for(let id in t) {
        if(id === 'th') {
            const heads = document.querySelectorAll('#th_row th');
            t.th.forEach((txt, i) => heads[i].innerText = txt);
        } else if(document.getElementById(id)) {
            document.getElementById(id).innerText = t[id];
        }
    }
}

function runBakChem() {
    const apiName = document.getElementById('apiSelect').value;
    const api = apiDb[apiName];
    const batch = parseInt(document.getElementById('batchSize').value);
    const strat = document.getElementById('strategy').value;
    
    document.getElementById('resultsArea').style.display = 'block';

    let score = strat === 'quality' ? 98 : 65;
    document.getElementById('perfFill').style.width = score + '%';
    document.getElementById('percText').innerText = score + '%';

    const formula = [
        { name: apiName, role: "Active API", qty: api.dose, color: api.color },
        { name: "Avicel PH-102", role: "Filler", qty: 120, color: "#3498db" },
        { name: "Ac-Di-Sol", role: "Disintegrant", qty: 25, color: "#27ae60" },
        { name: "Mg Stearate", role: "Lubricant", qty: 5, color: "#f1c40f" }
    ];

    let totalBatchCost = 0;
    const totalUnitWeight = api.dose + 150;

    document.getElementById('formulaBody').innerHTML = formula.map(f => {
        let unitCost = (f.qty * 0.0001); // افتراضي
        if(f.role === "API") unitCost = (f.qty * api.cost / 1000000);
        let batchCost = (unitCost * batch).toFixed(2);
        totalBatchCost += parseFloat(batchCost);
        return `<tr><td><b>${f.name}</b></td><td>${f.role}</td><td>${f.qty}</td><td>${((f.qty/totalUnitWeight)*100).toFixed(1)}%</td><td>$${batchCost}</td></tr>`;
    }).join('');

    document.getElementById('prodContent').innerHTML = `
        • <b>${currentLang==='ar'?'طريقة التصنيع':'Process'}:</b> ${api.process}<br>
        • <b>${currentLang==='ar'?'الوزن الكلي للوحدة':'Total Unit Weight'}:</b> ${totalUnitWeight} mg<br>
        • <b>${currentLang==='ar'?'إجمالي تكلفة التشغيلة':'Total Batch Cost'}:</b> <span style="color:var(--primary)">$${totalBatchCost.toFixed(2)}</span>
    `;

    document.getElementById('recContent').innerHTML = `
        • <b>${currentLang==='ar'?'ظروف التخزين':'Storage'}:</b> Temp < 25°C | RH < 60%<br>
        • <b>${currentLang==='ar'?'نوع التغليف':'Packaging'}:</b> Alu-PVC Blister Pack<br>
        • <b>${currentLang==='ar'?'الحماية':'Protection'}:</b> Protect from direct sunlight.
    `;

    document.getElementById('chartLegend').innerHTML = formula.map(f => `
        <div class="legend-item"><div class="dot" style="background:${f.color}"></div><span>${f.name}</span></div>
    `).join('');

    renderChart(formula);
}

function renderChart(data) {
    const ctx = document.getElementById('myChart').getContext('2d');
    if(chartObj) chartObj.destroy();
    chartObj = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.map(f => f.name),
            datasets: [{ data: data.map(f => f.qty), backgroundColor: data.map(f => f.color), borderWidth: 2 }]
        },
        options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
}

async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    
    // 1. علامة مائية شاملة الصفحة
    doc.setTextColor(248); doc.setFontSize(45);
    for (let i = 0; i < 10; i += 2) {
        for (let j = 0; j < 10; j += 2) { doc.text("BAKCHEM", i * 35, j * 45, { angle: 45 }); }
    }

    // 2. ترويسة التقرير
    doc.setFontSize(22); doc.setTextColor(14, 75, 98);
    doc.text("BakChemformula Technical Report", pageWidth / 2, 20, { align: "center" });
    
    // 3. درجة الجودة
    doc.setFontSize(14); doc.setTextColor(39, 174, 96);
    doc.text(`Quality Compliance Score: ${document.getElementById('percText').innerText}`, 20, 35);

    // 4. جدول التركيبة
    doc.autoTable({
        html: '#formulaTable', startY: 45, theme: 'grid',
        headStyles: { fillColor: [14, 75, 98], halign: 'center' },
        styles: { fontSize: 10, halign: 'center' }
    });

    let currentY = doc.lastAutoTable.finalY + 15;

    // 5. المخطط وتفسير الألوان
    const chartImg = document.getElementById('myChart').toDataURL("image/png");
    doc.addImage(chartImg, 'PNG', 15, currentY, 50, 50);

    doc.setFontSize(10); doc.setTextColor(50);
    const legendItems = document.querySelectorAll('.legend-item');
    legendItems.forEach((item, index) => {
        const dotColor = item.querySelector('.dot').style.backgroundColor;
        const rgb = dotColor.match(/\d+/g);
        doc.setFillColor(parseInt(rgb[0]), parseInt(rgb[1]), parseInt(rgb[2]));
        doc.rect(75, currentY + 10 + (index * 8), 4, 4, 'F');
        doc.text(item.innerText, 82, currentY + 13 + (index * 8));
    });

    // 6. بيانات الإنتاج والتوصيات
    currentY += 65;
    doc.setFontSize(14); doc.setTextColor(14, 75, 98);
    doc.text("Production & Batch Details:", 20, currentY);
    doc.setFontSize(11); doc.setTextColor(0);
    const prodLines = document.getElementById('prodContent').innerText.split('\n');
    prodLines.forEach((line, i) => doc.text(line, 20, currentY + 10 + (i * 6)));

    doc.setFontSize(14); doc.setTextColor(14, 75, 98);
    doc.text("Technical Recommendations:", 20, currentY + 35);
    doc.setFontSize(11); doc.setTextColor(0);
    const recLines = document.getElementById('recContent').innerText.split('\n');
    recLines.forEach((line, i) => doc.text(line, 20, currentY + 45 + (i * 6)));

    // 7. الباركود والتذييل
    JsBarcode("#barcode", "BK-2026-USP", { displayValue: false });
    doc.addImage(document.getElementById("barcode").toDataURL("image/png"), 'PNG', pageWidth - 60, pageHeight - 25, 45, 12);
    doc.setFontSize(8); doc.setTextColor(150);
    doc.text("© 2026 BakChemformula | Official Pharmaceutical Expert System Output", pageWidth / 2, pageHeight - 10, { align: "center" });

    doc.save("BakChem_Professional_Report.pdf");
}
</script>
</body>
</html>
