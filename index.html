<!DOCTYPE html>
<html lang="ar" dir="rtl" id="mainTag">
<head>
    <meta charset="UTF-8">
    <title>BakChemformula | Expert System Suite</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        :root { --primary: #0e4b62; --secondary: #3498db; --accent: #27ae60; --bg: #f0f2f5; --white: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        
        /* الهيكل العام للمساحات */
        .grid-layout { display: flex; flex-direction: column; gap: 20px; max-width: 1200px; margin: auto; }
        .section-box { background: var(--white); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 25px; overflow: hidden; border: 1px solid #e1e4e8; }
        
        /* زر اللغة */
        .lang-toggle { float: left; background: var(--secondary); color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; }

        /* المساحة الأولى: المدخلات */
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; align-items: end; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--primary); }
        select, input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .btn-run { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; }

        /* المساحة الثانية: الأداء والتركيبة */
        .performance-bar { height: 25px; background: #eee; border-radius: 15px; margin-bottom: 20px; position: relative; overflow: hidden; }
        .fill { height: 100%; background: linear-gradient(90deg, var(--secondary), var(--accent)); width: 0%; transition: 1.5s; }
        .bar-text { position: absolute; width: 100%; text-align: center; font-weight: bold; line-height: 25px; color: #000; }
        .formula-container { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }

        /* المساحة الثالثة: التشغيلة والتوصيات */
        .details-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: #f8f9fa; padding: 15px; border-right: 5px solid var(--secondary); border-radius: 6px; }

        /* المساحة الرابعة: التصدير والقانوني */
        .footer-section { text-align: center; }
        .legal-text { font-size: 0.85em; color: #666; margin-top: 15px; line-height: 1.6; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; }
        th { background: #f4f6f8; color: var(--primary); }
        
        canvas { max-height: 200px !important; }
        #resultsArea { display: none; }
    </style>
</head>
<body>

<div class="grid-layout">
    <div class="section-box">
        <button class="lang-toggle" onclick="toggleLang()" id="langBtn">English</button>
        <h2 id="h1" style="color:var(--primary); margin-top:0">1. خيارات المستخدم والمدخلات</h2>
        <div class="input-grid">
            <div>
                <label id="l_api">المادة الفعالة (API):</label>
                <select id="apiSelect">
                    <option value="Paracetamol">Paracetamol</option>
                    <option value="Diclofenac">Diclofenac</option>
                    <option value="Metronidazole">Metronidazole</option>
                </select>
            </div>
            <div>
                <label id="l_batch">حجم التشغيلة (Batch):</label>
                <input type="number" id="batchSize" value="1000">
            </div>
            <div>
                <label id="l_strat">الاستراتيجية:</label>
                <select id="strategy">
                    <option value="quality">جودة عالية (Q1/Q2)</option>
                    <option value="balanced">متوازن (Balanced)</option>
                    <option value="cost">أقل تكلفة (Cost)</option>
                </select>
            </div>
            <button class="btn-run" onclick="runBakChem()" id="btn_run">تحليل النظام</button>
        </div>
    </div>

    <div id="resultsArea" style="display:contents">
        <div class="section-box">
            <h2 id="h2" style="color:var(--primary); margin-top:0">2. تقييم الأداء والتركيبة المقترحة</h2>
            <div class="performance-bar">
                <div id="perfFill" class="fill"></div>
                <div class="bar-text" id="perfText">Efficiency Score: 0%</div>
            </div>
            <div class="formula-container">
                <div>
                    <table id="formulaTable">
                        <thead><tr id="th_row"><th>المادة</th><th>الوظيفة</th><th>(mg)</th><th>النسبة</th><th>التكلفة</th></tr></thead>
                        <tbody id="formulaBody"></tbody>
                    </table>
                </div>
                <div>
                    <canvas id="myChart"></canvas>
                </div>
            </div>
        </div>

        <div class="section-box">
            <h2 id="h3" style="color:var(--primary); margin-top:0">3. تفاصيل التشغيلة والتوصيات الفنية</h2>
            <div class="details-container">
                <div class="card" id="card_prod">
                    <h4 id="h_prod">بيانات الإنتاج والتشغيلة:</h4>
                    <div id="prodContent"></div>
                </div>
                <div class="card" style="border-color:var(--accent)" id="card_rec">
                    <h4 id="h_rec">توصيات البيئة والتغليف:</h4>
                    <div id="recContent"></div>
                </div>
            </div>
        </div>

        <div class="section-box footer-section">
            <button class="btn-run" style="background:var(--accent); max-width:300px" onclick="exportPDF()" id="btn_pdf">تصدير تقرير PDF احترافي</button>
            <div class="legal-text">
                <p><b>BakChemformula Expert System</b> | <span id="reg_id">رقم التسجيل الملكي: BK-2026-X-99</span></p>
                <p id="legal_info">هذا النظام مسجل بموجب قوانين حماية الملكية الفكرية كأداة ذكاء اصطناعي صيدلانية. جميع الحقوق محفوظة لـ BakChem.</p>
            </div>
        </div>
    </div>
</div>

<canvas id="barcode" style="display:none"></canvas>

<script>
let currentLang = 'ar';
const i18n = {
    ar: {
        h1: "1. خيارات المستخدم والمدخلات", h2: "2. تقييم الأداء والتركيبة المقترحة", h3: "3. تفاصيل التشغيلة والتوصيات الفنية",
        l_api: "المادة الفعالة:", l_batch: "حجم التشغيلة:", l_strat: "الاستراتيجية:", btn_run: "تحليل النظام",
        th: ["المادة", "الوظيفة", "وزن(mg)", "نسبة", "تكلفة"], h_prod: "بيانات الإنتاج والتشغيلة:",
        h_rec: "توصيات البيئة والتغليف:", btn_pdf: "تصدير تقرير PDF احترافي",
        legal_info: "هذا النظام مسجل بموجب قوانين حماية الملكية الفكرية كأداة ذكاء اصطناعي صيدلانية. جميع الحقوق محفوظة لـ BakChem."
    },
    en: {
        h1: "1. User Selection & Inputs", h2: "2. Performance Evaluation & Formulation", h3: "3. Batch Details & Technical Recommendations",
        l_api: "Active API:", l_batch: "Batch Size:", l_strat: "Strategy:", btn_run: "Analyze System",
        th: ["Material", "Role", "Weight(mg)", "Percentage", "Cost"], h_prod: "Production & Batch Data:",
        h_rec: "Storage & Packaging Recs:", btn_pdf: "Export Professional PDF",
        legal_info: "This system is registered under intellectual property laws as a pharmaceutical AI tool. All rights reserved to BakChem."
    }
};

const apiDb = {
    "Paracetamol": { dose: 500, cost: 14.5, process: "Direct Compression" },
    "Diclofenac": { dose: 50, cost: 82.0, process: "Wet Granulation" },
    "Metronidazole": { dose: 500, cost: 38.0, process: "Direct Compression" }
};

let chartObj = null;

function toggleLang() {
    currentLang = currentLang === 'ar' ? 'en' : 'ar';
    document.getElementById('mainTag').dir = currentLang === 'ar' ? 'rtl' : 'ltr';
    document.getElementById('langBtn').innerText = currentLang === 'ar' ? 'English' : 'العربية';
    const t = i18n[currentLang];
    for(let id in t) {
        if(id === 'th') {
            const heads = document.querySelectorAll('#th_row th');
            t.th.forEach((txt, i) => heads[i].innerText = txt);
        } else if(document.getElementById(id)) {
            document.getElementById(id).innerText = t[id];
        }
    }
}

function runBakChem() {
    const api = apiDb[document.getElementById('apiSelect').value];
    const batch = parseInt(document.getElementById('batchSize').value);
    const strat = document.getElementById('strategy').value;
    
    // Performance Logic
    let score = strat === 'quality' ? 98 : (strat === 'balanced' ? 82 : 60);
    document.getElementById('perfFill').style.width = score + '%';
    document.getElementById('perfText').innerText = `Efficiency Score: ${score}%`;

    const formula = [
        { name: document.getElementById('apiSelect').value, role: "API", qty: api.dose, cost: (api.dose * api.cost / 1000) },
        { name: "Microcrystalline Cellulose", role: "Filler", qty: 120, cost: 2.1 },
        { name: "Croscarmellose Sodium", role: "Disintegrant", qty: 25, cost: 4.5 },
        { name: "Magnesium Stearate", role: "Lubricant", qty: 5, cost: 1.1 }
    ];

    let totalBatchCost = 0;
    document.getElementById('formulaBody').innerHTML = formula.map(f => {
        let costBatch = (f.cost * batch / 100).toFixed(2);
        totalBatchCost += parseFloat(costBatch);
        return `<tr><td>${f.name}</td><td>${f.role}</td><td>${f.qty}</td><td>${((f.qty/(api.dose+150))*100).toFixed(1)}%</td><td>$${costBatch}</td></tr>`;
    }).join('');

    document.getElementById('prodContent').innerHTML = `
        • ${currentLang==='ar'?'طريقة التصنيع':'Process'}: <b>${api.process}</b><br>
        • ${currentLang==='ar'?'الوزن الكلي للقرص':'Unit Weight'}: ${api.dose+150} mg<br>
        • ${currentLang==='ar'?'تكلفة التشغيلة الإجمالية':'Total Batch Cost'}: <b style="color:var(--primary)">$${totalBatchCost.toFixed(2)}</b>
    `;

    document.getElementById('recContent').innerHTML = `
        • Temp: < 25°C | RH: < 60%<br>
        • Container: PVC/Alu Blister Pack<br>
        • Storage: Protected from light and moisture.
    `;

    renderChart(formula);
}

function renderChart(data) {
    const ctx = document.getElementById('myChart').getContext('2d');
    if(chartObj) chartObj.destroy();
    chartObj = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.map(f => f.name),
            datasets: [{ data: data.map(f => f.qty), backgroundColor: ['#0e4b62', '#3498db', '#27ae60', '#f1c40f'] }]
        },
        options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
}

function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(22); doc.setTextColor(14, 75, 98);
    doc.text("BakChemformula Technical Report", 105, 20, {align: "center"});
    doc.autoTable({ html: '#formulaTable', startY: 30, theme: 'grid' });
    
    doc.setTextColor(240); doc.setFontSize(40);
    doc.text("CONFIDENTIAL - REGISTERED", 30, 150, { angle: 45 });
    
    JsBarcode("#barcode", "BK-2026-X1");
    const canvas = document.getElementById("barcode");
    doc.addImage(canvas.toDataURL("image/png"), 'PNG', 150, 260, 45, 15);
    doc.save("BakChem_Report.pdf");
}
</script>
</body>
</html>
