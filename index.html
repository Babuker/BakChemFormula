<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>BakChemformula | Professional Suite</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        :root { --primary: #0e4b62; --secondary: #3498db; --accent: #27ae60; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .header { text-align: center; border-bottom: 3px solid var(--primary); margin-bottom: 25px; padding-bottom: 10px; }
        .input-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; background: #f1f4f6; padding: 20px; border-radius: 10px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; color: var(--primary); }
        select, input, button { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 15px; margin-bottom: 10px; }
        .btn-run { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; font-size: 18px; }
        .btn-run:hover { background: #083242; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„ØªÙƒÙ„ÙØ© */
        .status-card { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 10px; }
        .progress-container { background: #eee; height: 15px; border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; transition: 1s ease-in-out; }
        .quality-fill { background: var(--accent); }
        .cost-fill { background: #e67e22; }

        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; display: none; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: var(--primary); color: white; }
        .recommendation-box { background: #e8f4fd; padding: 15px; border-right: 5px solid var(--secondary); border-radius: 5px; margin-top: 15px; }
        canvas { max-width: 100%; height: 250px !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>BakChemformula <span style="font-size: 0.4em; vertical-align: middle;">Expert System v2.5</span></h1>
        <p>Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø®Ø¨ÙŠØ± Ù„ØªØµÙ…ÙŠÙ… ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙŠØº Ø§Ù„ØµÙŠØ¯Ù„Ø§Ù†ÙŠØ© ÙˆØ§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¹ÙŠØ§Ø±ÙŠØ©</p>
    </div>

    <div class="input-section">
        <div>
            <label>Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ÙØ¹Ø§Ù„Ø© (API):</label>
            <select id="apiSelect">
                <option value="Paracetamol">Paracetamol (Analgesic)</option>
                <option value="Diclofenac">Diclofenac (Acid Sensitive)</option>
                <option value="Metronidazole">Metronidazole (Bitter/Moisture)</option>
            </select>
            <label>Ø­Ø¬Ù… Ø§Ù„ØªØ´ØºÙŠÙ„Ø© (Batch Units):</label>
            <input type="number" id="batchSize" value="1000">
        </div>
        <div>
            <label>Ø¥Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„ØªØµÙ†ÙŠØ¹:</label>
            <select id="strategy">
                <option value="quality">Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© (Q1/Q2 Compliance)</option>
                <option value="balanced">Ù…ØªÙˆØ§Ø²Ù† (Performance & Cost)</option>
                <option value="cost">ØªÙƒÙ„ÙØ© Ø§Ù‚ØªØµØ§Ø¯ÙŠØ© (Budget Friendly)</option>
            </select>
            <button class="btn-run" onclick="calculateBakChem()">ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ØµÙŠØºØ©</button>
        </div>
    </div>

    <div id="resultsArea" class="results-grid">
        <div class="right-panel">
            <div class="status-card">
                <label>Ù…Ø¤Ø´Ø± Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© (Quality Index):</label>
                <div class="progress-container"><div id="qualityBar" class="progress-fill quality-fill"></div></div>
                
                <label>Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ØªÙƒÙ„ÙØ© (Cost Optimization):</label>
                <div class="progress-container"><div id="costBar" class="progress-fill cost-fill"></div></div>
            </div>

            <table>
                <thead><tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>(mg)</th><th>Ø§Ù„Ù†Ø³Ø¨Ø©</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th></tr></thead>
                <tbody id="formulaTable"></tbody>
            </table>
        </div>

        <div class="left-panel">
            <div class="recommendation-box" id="techBox"></div>
            <div class="recommendation-box" style="background:#fdf2e9; border-color:#e67e22" id="storageBox"></div>
            <canvas id="formulaChart"></canvas>
            <button class="btn-run" style="background:var(--accent); margin-top:10px;" onclick="exportPDF()">ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ (PDF)</button>
        </div>
    </div>
</div>

<canvas id="barcode" style="display:none"></canvas>

<script>
const db = {
    "Paracetamol": { dose: 500, cost: 14.5, solubility: "Low", sensitivity: "None" },
    "Diclofenac": { dose: 50, cost: 82.0, solubility: "Low", sensitivity: "Acid" },
    "Metronidazole": { dose: 500, cost: 38.0, solubility: "Medium", sensitivity: "Moisture" }
};

let myChart = null;

function calculateBakChem() {
    const api = db[document.getElementById('apiSelect').value];
    const strategy = document.getElementById('strategy').value;
    const batch = parseInt(document.getElementById('batchSize').value);

    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª
    let qualityScore, costScore, filler, disintegrant, method;
    
    if(strategy === "quality") {
        qualityScore = 98; costScore = 40;
        filler = "Avicel PH-102 (Premium)";
        disintegrant = "Ac-Di-Sol (Super)";
        method = "Ø§Ù„ÙƒØ¨Ø³ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Direct Compression)";
    } else if(strategy === "balanced") {
        qualityScore = 85; costScore = 70;
        filler = "Lactose Monohydrate";
        disintegrant = "Primojel";
        method = "Ø§Ù„ØªØ­Ø¨ÙŠØ¨ Ø§Ù„Ø±Ø·Ø¨ (Wet Granulation)";
    } else {
        qualityScore = 65; costScore = 95;
        filler = "Native Starch";
        disintegrant = "Maize Starch";
        method = "Ø§Ù„ØªØ­Ø¨ÙŠØ¨ Ø§Ù„Ø¬Ø§Ù (Dry Granulation)";
    }

    const totalWeight = api.dose + 150;
    const formula = [
        { name: document.getElementById('apiSelect').value, qty: api.dose, cost: (api.dose * api.cost / 1000) },
        { name: filler, qty: 120, cost: 2.5 },
        { name: disintegrant, qty: 20, cost: 4.0 },
        { name: "Magnesium Stearate", qty: 10, cost: 1.2 }
    ];

    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    document.getElementById('resultsArea').style.display = 'grid';
    document.getElementById('qualityBar').style.width = qualityScore + '%';
    document.getElementById('costBar').style.width = costScore + '%';

    document.getElementById('formulaTable').innerHTML = formula.map(f => `
        <tr><td>${f.name}</td><td>${f.qty}</td><td>${((f.qty/totalWeight)*100).toFixed(1)}%</td><td>$${(f.cost * batch / 100).toFixed(2)}</td></tr>
    `).join('');

    document.getElementById('techBox').innerHTML = `
        <b>ğŸš› Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬:</b><br>
        â€¢ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØµÙ†ÙŠØ¹: ${method}<br>
        â€¢ ÙˆØ²Ù† Ø§Ù„ÙˆØ­Ø¯Ø©: ${totalWeight} mg<br>
        â€¢ Ø¥Ù†ØªØ§Ø¬ÙŠØ© Ø§Ù„ØªØ´ØºÙŠÙ„Ø©: ${(totalWeight * batch / 1000).toFixed(2)} Ø¬Ø±Ø§Ù…
    `;

    document.getElementById('storageBox').innerHTML = `
        <b>ğŸŒ¡ï¸ ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„ØªØºÙ„ÙŠÙ:</b><br>
        â€¢ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©: ØªØ­Øª 25Â°C<br>
        â€¢ Ø§Ù„Ø±Ø·ÙˆØ¨Ø©: < 60% (RH)<br>
        â€¢ Ø§Ù„ØªØºÙ„ÙŠÙ: Blister Pack (Alu-PVC)
    `;

    updateChart(formula);
}

function updateChart(formula) {
    const ctx = document.getElementById('formulaChart').getContext('2d');
    if(myChart) myChart.destroy();
    myChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: formula.map(f => f.name),
            datasets: [{ data: formula.map(f => f.qty), backgroundColor: ['#0e4b62', '#3498db', '#27ae60', '#f1c40f'] }]
        }
    });
}

function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const barcodeVal = "BAK-" + Math.floor(Math.random()*90000);
    
    // Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ©
    doc.setTextColor(240);
    doc.setFontSize(50);
    doc.text("CONFIDENTIAL", 40, 150, { angle: 45 });
    
    doc.setTextColor(0);
    doc.setFontSize(20);
    doc.text("BakChemformula Technical Report", 10, 20);
    
    doc.autoTable({ html: 'table', startY: 30 });
    
    // Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    JsBarcode("#barcode", barcodeVal);
    const canvas = document.getElementById("barcode");
    doc.addImage(canvas.toDataURL("image/png"), 'PNG', 150, 260, 40, 15);
    
    doc.save(`BakChem_Report_${barcodeVal}.pdf`);
}
</script>
</body>
</html>
